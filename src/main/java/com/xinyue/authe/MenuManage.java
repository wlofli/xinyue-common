package com.xinyue.authe;

import java.util.ArrayList;
import java.util.Enumeration;
import java.util.Hashtable;
import java.util.List;

import org.apache.ibatis.session.SqlSession;
import org.apache.ibatis.session.SqlSessionFactory;

public class MenuManage {
	private static Hashtable<Integer,MenuItem> menuList;
	private static Hashtable<Integer,ArrayList<MenuItem>> root;
	private static ArrayList<OptionInfo> menuOpList;
	
	
	public static String menuJson(LoginUserInfo user){
		StringBuilder result = new StringBuilder();
		if (user==null)
			return "";
		
		if (menuOpList==null)
			menuOpList = OptionManage.getMenuList();                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
		
		int uid = user.getUid();
		int[] gid = user.getGid();
		boolean isAdmin = user.getAdmin();
		int count = 0;
		
		result.append("[");
		for (int i=0;i<menuOpList.size();i++){
			OptionInfo opInfo = menuOpList.get(i);
			
			if (!isAdmin&&!opInfo.checkAuthe(uid, gid)){
				continue;
			}
			if (count>0)
				result.append(",");
			
			int menuId = opInfo.getMenuId();
			MenuItem mItem = getMenuInfo(menuId);
			if (mItem==null)
				continue;
			
			String mName = mItem.getText();
			String url = opInfo.getUrl();
			if (url==null||url.equals(""))
				url = opInfo.getOptionId();
			String text = opInfo.getName();
			String extend = mItem.getExtend();
			result.append("{");
			result.append("\"menu\":\"" + mName+"\",");
			result.append("\"text\":\""+text+"\",");
			result.append("\"url\":\""+url+"\",");
			result.append("\"classname\":\""+extend+"\"");
			result.append("}");
			count ++;	
		}
		result.append("]");
		return result.toString();	
	}
	
	public static MenuItem getMenuInfo(int menuId){
		if (menuList == null)
			init();
		return menuList.get(menuId);
	}
	
	/**
	 * 获取详细菜单树 上下级菜单中间使用“|”分隔
	 * @param menuId
	 * @return
	 */
	public static String getMenuString(int menuId){
		String outStr = "";
		int mId = menuId;
		while(mId>0){
			MenuItem mItem = getMenuInfo(menuId);
			outStr = "|" + mItem.getText() + outStr;
			mId = mItem.getParentId();
		}
		return outStr;
	}
	
	public synchronized static void delMenuItem(int menuId)throws Exception{
		/*MenuItem item = getMenuInfo(menuId);
		if (item.getChildItems()>0)
			throw new Exception("该菜单项下，还有其他菜单项，不能删除");*/
	}

	
	public synchronized static void addMenuItem(String text,int parentId,String remark)throws Exception{
		if (text == null || text.equals(""))
			throw new Exception("菜单显示文字为空");

		SqlSessionFactory sessionFactory = AutheManage.getSqlSession();
		SqlSession session = sessionFactory.openSession();
		AutheMapper mapper = session.getMapper(AutheMapper.class);
		int re = mapper.addMenu(text, parentId, remark);
		MenuItem menuItem;
		if (re>0){
			menuItem = mapper.getMenu(parentId, text);
			menuList.put(menuItem.getId(), menuItem);
		}
		session.close();
		if (re<=0)
			throw new Exception("保存菜单到数据库错误");
		
	}
	
	private static void treeInit(){
		root = new Hashtable<Integer,ArrayList<MenuItem>>();
		Enumeration<Integer> keys = menuList.keys();
		while (keys.hasMoreElements()) {				
			int  mid = keys.nextElement();
			MenuItem mItem=menuList.get(mid); 
			int parentId = mItem.getParentId();
			if (!root.containsKey(parentId)){
				ArrayList<MenuItem> nodeList= new ArrayList<MenuItem>();
				nodeList.add(mItem);
				root.put(parentId, nodeList);
			}
			else{
				ArrayList<MenuItem> nodeList = root.get(parentId);
				nodeList.add(mItem);
			}
		}
	}
	
	public synchronized static void optionMenu(OptionInfo opInfo){
		if (opInfo == null)
			return;
		
		int parentId = opInfo.getMenuId();
		MenuItem mItem = new MenuItem();
		mItem.setId(-1);
		mItem.setParentId(parentId);
		mItem.setText(opInfo.getName());
		mItem.setMenu(false);
		mItem.setUrl(opInfo.getOptionId());
		
		if (!root.containsKey(parentId)){
			ArrayList<MenuItem> nodeList= new ArrayList<MenuItem>();
			nodeList.add(mItem);
			root.put(parentId, nodeList);
		}
		else{
			ArrayList<MenuItem> nodeList = root.get(parentId);
			nodeList.add(mItem);
		}
	}
	
	public synchronized static void init(){
		if (menuList!=null)
			return;
		
		try{
			SqlSessionFactory sessionFactory =   AutheManage.getSqlSession();
			SqlSession session = sessionFactory.openSession();
			AutheMapper mapper = session.getMapper(AutheMapper.class);
			List<MenuItem> mList = mapper.getMenuList();
			session.close();
			menuList = new Hashtable<Integer,MenuItem>();
			for (int i =0 ;i<mList.size();i++){
				MenuItem menu = mList.get(i);
				menuList.put(menu.getId(), menu);
			}
			treeInit();
		/*	
			Enumeration<Integer> keys = menuList.keys();
			while (keys.hasMoreElements()) {				
				int  mid = keys.nextElement();
				MenuItem mItem=menuList.get(mid);    
			    setChildItems(mItem);
			}*/
		}
		catch(Exception e){
			e.printStackTrace();
		}
	}
}
