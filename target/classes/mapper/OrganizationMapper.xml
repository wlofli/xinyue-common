<?xml version="1.0" encoding="UTF-8"?>
<!-- wenhai.you -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.xinyue.manage.dao.OrganizationDao">
	<resultMap type="com.xinyue.manage.beans.SelectInfo" id="selectResult">
		<result column="skey" property="key" />
		<result column="svalue" property="value" />
	</resultMap>

	<!-- ywh 添加机构信息 -->
	<insert id="addOrg">
		insert into m_organization_info 
		 (id, name, genre,number, site, province_id , city_id , zone_id , postcode, pinying , created_time , modified_time , modified_id , created_id , deleted , status)
		VALUES 
		 (replace(uuid(),'-' , ''), #{org.name} , #{org.genre} , #{org.number} , #{org.site} ,#{org.provinceid} , #{org.cityid} , #{org.zoneid},
		  #{org.postcode} , #{org.pinyin},now() ,now(), #{createUser} , #{createUser} , 0 , #{org.status});
		
	</insert>
	
	
	
	<select id="findOrgNameByPinying" resultType="com.xinyue.manage.model.Organization">
		select * from m_organization_info where deleted = 0 and status = 0 and pinying like concat(#{pinying} , '%') or name like concat(#{pinying} , '%') group by number
	</select>
	<!-- and status = 0 ywh -->
	<select id="getOrganizations" resultMap="selectResult">
		SELECT 
		    id as skey, name as svalue
		FROM
		    m_organization_info
		where
		    deleted = 0 and status = 0 
		order by number;
	</select>
	
	<!-- ywh 修改联系人 -->
	<update id="updateOrgLinkMan" parameterType="com.xinyue.manage.model.LinkMan">
		update m_linkman_info set name = #{name} , sex = #{sex} , position = #{position} , 
			telphone = #{telphone} , fixed = #{fixed} , fax = #{fax} , mail = #{mail} where id = #{id}
	</update>
	
	<!-- ywh 添加联系人 -->
	<insert id="addOrgLinkMan" parameterType="com.xinyue.manage.model.LinkMan">
		insert into m_linkman_info(name , sex , position , telphone , fixed , fax , mail , orgid) 
		values(#{name} , #{sex} , #{position} , #{telphone} , #{fixed} , #{fax} , #{mail} , #{orgid})
	</insert>
	
	<!--ywh 2015-09-08下显示店铺设置信息 和 显示机构基本信息和联系人信息 -->
	<select id="findShop" resultMap="orgResultMap">
		select 
		o.* , c.id statid , c.substation_name subName ,t.id ptypeid , t.name typeName , 
		concat_ws('' , a.name , b.name , z.name ) address , m.select_value  scaleName , d.name  genreName ,
		i.id linkmanid , i.name linkName , i.sex , si.select_value sexName ,i.telphone ,  i.position , i.fixed , i.fax, i.mail 
		from m_organization_info o 
		left join m_organization_type d on d.otypeid = o.genre and d.deleted = 0 
		left join m_linkman_info i on i.orgid = o.id 
		left join m_select_info si on si.select_key = i.sex and si.type_code = 'sex' 
		left join m_select_info m  on m.select_key = o.scale and m.type_code = 'org_scale' 
		left join m_area_province a on a.code = o.province_id 
		left join m_area_city b on b.code = o.city_id 
		left join m_area_zone z on z.code = o.zone_id 
		left join m_substation_org s on s.org_id = o.id 
		left join m_city_substation_info c on s.stat_id = c.id 
		left join m_org_product_type p on p.org_id = o.id 
		left join m_product_type t on t.id = p.ptype_id where o.id = #{orgid}
	</select>
	<resultMap type="com.xinyue.manage.model.Organization" id="orgResultMap">
		<id property="id" column="id"/>
		<result property="name" column="name"/>
		<result property="number" column="number"/>
		<result property="postcode" column="postcode"/>
		<result property="shortName" column="shortName"/>
		<result property="genre" column="genre"/>
		<result property="genreName" column="genreName"/>
		<result property="establish" column="establish"/>
		<result property="scale" column="scale"/>
		<result property="scaleName" column="scaleName"/>
		<result property="status" column="status"/>
		<result property="provinceid" column="province_id"/>
		<result property="cityid" column="city_id"/>
		<result property="cid" column="city_id"/>
		<result property="zoneid" column="zone_id"/>
		<result property="zid" column="zone_id"/>
		<result property="site" column="site"/>
		<result property="address" column="address"/>
		<result property="domain" column="domain"/>
		<result property="regNum" column="reg_Num"/>
		<result property="capital" column="capital"/>
		<result property="pv" column="pv"/>
		<result property="introduce" column="introduce"/>
		<result property="description" column="description"/>
		<result property="image" column="org_img"/>
		<result property="notice" column="notice"/>
		<collection property="stat" ofType="com.xinyue.manage.model.SubStation">
			<id property="id" column="statid"/>
			<result property="subName" column="subName"/>
		</collection>
		<collection property="ptype" ofType="com.xinyue.manage.model.ProductType">
			<id property="id" column="ptypeid"/>
			<result property="name" column="typeName"/>
		</collection>
		<collection property="linkman" ofType="com.xinyue.manage.model.LinkMan">
			<id property="id" column="linkmanid"/>
			<result property="name" column="linkName"/>
			<result property="sex" column="sex"/>
			<result property="sexName" column="sexName"/>
			<result property="telphone" column="telphone"/>
			<result property="fixed" column="fixed"/>
			<result property="fax" column="fax"/>
			<result property="mail" column="mail"/>
			<result property="position" column="position"/>
		</collection>
	</resultMap>
	
	<!-- ywh根据域名或机构名称 判断相对应信息是否存在 -->
	<select id="checkOrgNameOrDomain" resultType="com.xinyue.manage.model.Organization">
		select * from m_organization_info 
		where id != #{orgid}   
		<if test="domain != null and domain != ''">
			and domain = #{domain}  
		</if>
		<if test="orgName != null and orgName != ''">
			and name = #{orgName}
		</if>
	</select>
	
	<!-- ywh添加业务区域时先删除 再添加 -->
	<delete id="delOrgStation">
		delete from m_substation_org where org_id = #{orgid}
	</delete>
	<insert id="addOrgStation">
		insert into m_substation_org(org_id , stat_id) values
		<foreach collection="list" item="item" index="index" close=";" separator=",">
			(#{orgid} , #{item}) 
		</foreach>
	</insert>
	
	<!-- ywh 添加擅长业务时 先删除再添加 -->
	<delete id="delOrgProType">
		delete from m_org_product_type where org_id = #{orgid}
	</delete>
	<insert id="addOrgProType">
		insert into m_org_product_type(org_id , ptype_id) values
		<foreach collection="list" item="item" index="index" close=";" separator=",">
			(#{orgid} , #{item})
		</foreach>
	</insert>
	
	<!--ywh 修改机构信息 包括店铺信息和机构基本信息 -->
	<update id="updateOrg">
		update m_organization_info set 
			<if test="org.content != null and org.content != ''">
				description = #{org.content} ,
			</if>
			<if test="org.name != null and org.name != ''">
				name = #{org.name}, 
			</if>
			<if test="org.shortName != null and org.shortName != ''">
				shortName = #{org.shortName},
			</if>
			<if test="org.pinyin != null and org.pinyin != ''">
				pinying = #{org.pinyin},
			</if>
			<if test="org.genre != null and org.genre != ''">
				genre = #{org.genre}, 
			</if>
			<if test="org.establish != null and org.establish != ''">
				establish = #{org.establish},
			</if> 
			<if test="org.scale != null and org.scale != ''">
				scale = #{org.scale},
			</if>
			<if test="org.provinceid != null and org.provinceid != ''">
				province_id = ${org.provinceid},
			</if>
			<if test="org.cityid != null and org.cityid != ''">
				city_id = #{org.cityid},
			</if>
			<if test="org.zoneid != null and org.zoneid != ''">
				zone_id = #{org.zoneid},
			</if>
			<if test="org.site != null and org.site != ''">
				site = #{org.site},
			</if>
			<if test="org.postcode != null and org.postcode != ''">
				postcode = #{org.postcode},
			</if>
			<if test="org.status != null and org.status != ''">
				status = #{org.status},
			</if>
			<if test="org.domain != null and org.domain != ''">
				domain = #{org.domain},
			</if>
			<if test="org.regNum != null and org.regNum != ''">
				reg_num = #{org.regNum},
			</if>
			<if test="org.capital != null and org.capital != ''">
				capital = #{org.capital},
			</if>
			<if test="org.pv != null and org.pv != ''">
				pv = #{org.pv},
			</if>
			<if test="org.introduce != null and org.introduce != ''">
				introduce = #{org.introduce},
			</if>
			<if test="org.image != null and org.image != ''">
				org_img = #{org.image},
			</if>
			<if test="org.notice != null and org.notice != ''">
				notice = #{org.notice}, 
			</if>
			modified_time = now(),
			modified_id = #{modifyUser}
			where id = #{org.id}
	</update>
	
	<!-- ywh显示机构列表信息 -->
	<select id="findOrgList" resultType="com.xinyue.manage.model.Organization">
		select o.id,
			o.name,
			s.name genre,
			o.number,
			site site,
			o.postcode ,
			l.name linkName,
			i.select_value sex ,
			l.position ,
			l.telphone ,
			l.fixed,
			l.fax,
			l.mail,
			o.status,
			o.deleted 
		from m_organization_info o 
		left join m_organization_type s on o.genre = s.otypeid 
		left join (select * from m_linkman_info t group by t.orgid) l on l.orgid = o.id  
		left join m_select_info i on l.sex = i.select_key and i.type_code = 'sex' 
		where o.deleted = 0
			<if test="orgInfo.name != null and orgInfo.name != ''"> and o.name like concat(#{orgInfo.name},'%')</if>
			<if test="orgInfo.genre != null and orgInfo.genre != 0 "> and o.genre = #{orgInfo.genre}</if>
			<if test="orgInfo.linkman != null and orgInfo.linkman != ''"> and l.name like concat(#{orgInfo.linkman} , '%')</if>
			<if test="orgInfo.telphone != null and orgInfo.telphone != ''"> and l.telphone like concat(#{orgInfo.telphone},'%')</if>
			<if test="orgInfo.status != null and orgInfo.status != ''"> and o.status = #{orgInfo.status}</if>
		 limit #{start} , #{pageSize}
	
	</select>
	
	<!-- ywh统计机构列表信息 -->
	<select id="getOrgCount" resultType="int">
		select count(*) from m_organization_info o 
		left join m_organization_type s on o.genre = s.otypeid 
		left join (select * from m_linkman_info t group by t.orgid) l on l.orgid = o.id  
		left join m_select_info i on l.sex = i.select_key and i.type_code = 'sex' 
		where o.deleted = 0
			<if test="orgInfo.name != null and orgInfo.name != ''"> and o.name like concat(#{orgInfo.name},'%')</if>
			<if test="orgInfo.genre != null and orgInfo.genre != 0 "> and o.genre = #{orgInfo.genre}</if>
			<if test="orgInfo.linkman != null and orgInfo.linkman != ''"> and l.name like concat(#{orgInfo.linkman} , '%')</if>
			<if test="orgInfo.telphone != null and orgInfo.telphone != ''"> and l.telphone like concat(#{orgInfo.telphone},'%')</if>
			<if test="orgInfo.status != null and orgInfo.status != ''"> and o.status = #{orgInfo.status}</if>
	</select>
	
	<!-- ywh 屏蔽机构 -->
	<update id="updateDisable">
		update m_organization_info set status = 1 , modified_time=now() , modified_id = #{modifyUser}
		where id = 
		<foreach collection="list" item="item" index="index" separator=" or id = "  >  
	        #{item}  
	    </foreach>
	</update>
	
	<!-- ywh 启用机构 -->
	<update id="updateEnable">
		update m_organization_info set status = 0 , modified_time=now() , modified_id = #{modifyUser}
		where id = 
		<foreach collection="list" item="item" index="index" separator=" or id = "  >  
	        #{item}  
	    </foreach>
	</update>
	
	<!-- ywh 删除机构 -->
	<update id="updateMarker">
		update m_organization_info set deleted = 1 , modified_time=now() , modified_id = #{modifyUser}
		where id = 
		<foreach collection="list" item="item" index="index" separator=" or id = "  >  
	        #{item}  
	    </foreach>
	</update>
	<!-- ywh 只供后台调用  获取所有未删除的机构 -->
	<select id="getOrgs" resultMap="selectResult">
		SELECT 
		    id as skey, name as svalue
		FROM
		    m_organization_info
		where
		    deleted = 0 
	</select>
	
	<!-- ywh admin 店铺设置 credit  -->
	<select id="findCreditByOrgid" resultType="com.xinyue.manage.model.CreditManager">
		select 
	    m.id as id,
	    m.real_name as realName,
	    case m.sex
	        when 1 then '女'
	        when 2 then '男'
	        when 3 then '保密'
	    end as sex,
	    case i.audit 
			when 4 then '已认证' 
			else '未认证' 
		end as auditName, 
		m.status , 
		case when level = 1 then num else 0 end  as one , 
		case when level = 2 then  num  else 0 end as two ,
		case when level = 3 then  num  else 0 end as three ,
		case when level = 4 then  num  else 0 end as four ,
		case when level = 5 then  num  else 0 end as five ,
		i.idcard card,
	    m.star_level as star,
		m.email as email,
	    p.name as province,
	    c.name as city,
	    m.tel_number tel , 
	    date_format(m.created_time, '%Y-%m-%d') as registerDate 
		from c_manager_info m
	    left join m_area_province p ON p.code = m.province
	    left join m_area_city c ON c.code = m.city 
	    left join c_certification_info i on i.userid = m.id 
		left join (select level, credit_manager_id , count(*) num from m_order_info group by credit_manager_id , level) t on t.credit_manager_id = m.id
	where 
		m.deleted = 0 and m.organization = #{sc.orgid} 
		<if test="sc.creditManagerName != null and sc.creditManagerName != '' ">
			and m.real_name like concat(#{sc.creditManagerName} , '%') 
		</if> 
		<if test="sc.sex != null and sc.sex != ''">
			and m.sex = #{sc.sex} 
		</if>
		<if test="sc.telPhone != null and sc.telPhone != ''">
			and m.tel_number like concat(#{sc.telPhone}, '%') 
		</if>
		<if test="sc.province != null and sc.province != ''">
			and p.code = #{sc.province}
		</if>
		<if test="sc.city != null and sc.city != ''">
			and c.code = #{sc.city}
		</if>
		<if test="sc.serverStar != null and sc.serverStar != ''">
			and m.star_level = #{sc.serverStar}
		</if>
		<if test="sc.audit != null and sc.audit != ''">
			<choose>
				<when test="sc.audit == 4">
					and i.audit = 4
				</when>
				<otherwise>
					and (i.audit != 4 or i.audit is null ) 
				</otherwise>
			</choose>			
		</if>
		limit #{start} , #{pageSize}
	</select>
	<select id="getCreditByOrgidCount" resultType="int">
		select count(*) from c_manager_info m
	        left join m_area_province p ON p.code = m.province
	        left join m_area_city c ON c.code = m.city 
	        left join c_certification_info i on i.userid = m.id 
			left join (select level, credit_manager_id , count(*) num from m_order_info group by credit_manager_id , level) t on t.credit_manager_id = m.id
		where m.deleted = 0 and m.organization = #{orgid} 
		<if test="creditManagerName != null and creditManagerName != '' ">
			and m.real_name like concat(#{creditManagerName} , '%') 
		</if> 
		<if test="sex != null and sex != ''">
			and m.sex = #{sex} 
		</if>
		<if test="telPhone != null and telPhone != ''">
			and m.tel_number like concat(#{telPhone}, '%') 
		</if>
		<if test="province != null and province != ''">
			and p.code = #{province}
		</if>
		<if test="city != null and city != ''">
			and c.code = #{city}
		</if>
		<if test="serverStar != null and serverStar != ''">
			and m.star_level = #{serverStar}
		</if>
		<if test="audit != null and audit != ''">
			<choose>
				<when test="audit == 4">
					and i.audit = 4
				</when>
				<otherwise>
					and (i.audit != 4 or i.audit is null ) 
				</otherwise>
			</choose>			
		</if>
	</select>
	
</mapper>